name: Unit Tests

on:
  push:
    branches: [ main, develop, personality_disorder_innit ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio
    
    - name: Install lcov for coverage
      run: |
        sudo apt-get update
        sudo apt-get install -y lcov bc
    
    - name: Run native unit tests
      run: pio test -e native -v
    
    - name: Run tests with coverage
      run: |
        # Rebuild with coverage flags
        pio test -e native_coverage -v 2>&1 || true
        
        # Generate coverage report
        lcov --capture --directory .pio/build/native_coverage/ \
             --output-file coverage.info \
             --ignore-errors mismatch,empty,unused 2>/dev/null || true
        
        # Filter to only project files (exclude Unity framework, system headers)
        lcov --remove coverage.info \
             '/usr/*' \
             '*/test/*' \
             '*/.pio/*' \
             '*/unity/*' \
             --output-file coverage_filtered.info \
             --ignore-errors unused 2>/dev/null || true
    
    - name: Check coverage threshold
      run: |
        # Extract coverage percentage
        if [ -f coverage_filtered.info ]; then
          COVERAGE=$(lcov --summary coverage_filtered.info 2>&1 | grep -oP 'lines\.*: \K[0-9.]+' | head -1 || echo "0")
          echo "Line coverage: ${COVERAGE}%"
          
          # Check against 70% threshold
          THRESHOLD=70
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "::error::Coverage ${COVERAGE}% is below threshold of ${THRESHOLD}%"
            exit 1
          else
            echo "::notice::Coverage ${COVERAGE}% meets threshold of ${THRESHOLD}%"
          fi
        else
          echo "::warning::Coverage report not generated - running tests only"
        fi
    
    - name: Generate HTML coverage report
      if: always()
      run: |
        if [ -f coverage_filtered.info ]; then
          genhtml coverage_filtered.info --output-directory coverage_html --ignore-errors unmapped
        fi
    
    - name: Upload coverage report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage_html/
        retention-days: 7
        if-no-files-found: ignore
    
    - name: Upload coverage to Codecov
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: codecov/codecov-action@v4
      with:
        files: coverage_filtered.info
        fail_ci_if_error: false
        verbose: true
      continue-on-error: true

  build:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio
    
    - name: Build firmware
      run: |
        pio run -e m5cardputer
    
    - name: Upload firmware artifact
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: .pio/build/m5cardputer/firmware.bin
        retention-days: 30
